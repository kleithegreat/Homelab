---
- name: Create Filebrowser directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: "1000"
    group: "1000"
  loop:
    - "{{ data_root }}/filebrowser"
    - "{{ data_root }}/filebrowser/database"

- name: Check if Filebrowser database exists
  stat:
    path: "{{ data_root }}/filebrowser/database/filebrowser.db"
  register: fb_db

- name: Deploy Filebrowser container
  community.docker.docker_container:
    name: filebrowser
    image: "filebrowser/filebrowser:{{ filebrowser_version }}"
    restart_policy: unless-stopped
    networks:
      - name: "{{ docker_network }}"
    ports:
      - "{{ ports.filebrowser }}:80"
    volumes:
      - "{{ filebrowser_root }}:/srv"
      - "{{ data_root }}/filebrowser/database:/database"
    env:
      PUID: "1000"
      PGID: "1000"

- name: Wait for Filebrowser to initialize
  pause:
    seconds: 3
  when: not fb_db.stat.exists

- name: Get Filebrowser initial password
  shell: docker logs filebrowser 2>&1 | grep -oP 'password:\s*\K\S+'
  register: fb_password
  changed_when: false
  when: not fb_db.stat.exists

- name: Show Filebrowser admin credentials
  debug:
    msg: "Filebrowser admin password: {{ fb_password.stdout }}"
  when: not fb_db.stat.exists and fb_password.stdout | length > 0