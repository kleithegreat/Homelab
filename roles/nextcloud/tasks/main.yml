---
- name: Create Nextcloud directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ data_root }}/nextcloud/html"
    - "{{ data_root }}/nextcloud/data"

- name: Create Nextcloud database
  community.docker.docker_container:
    name: nextcloud-db-init
    image: "postgres:16-alpine"
    state: started
    detach: false
    cleanup: true
    networks:
      - name: "{{ docker_network }}"
    env:
      PGPASSWORD: "{{ postgres_password }}"
    command: >
      sh -c "
        until pg_isready -h postgres -U {{ postgres_user }}; do sleep 2; done;
        psql -h postgres -U {{ postgres_user }} -tc \"SELECT 1 FROM pg_database WHERE datname = 'nextcloud'\" | grep -q 1 || 
        psql -h postgres -U {{ postgres_user }} -c 'CREATE DATABASE nextcloud;'
      "

- name: Deploy Nextcloud container
  community.docker.docker_container:
    name: nextcloud
    image: "nextcloud:{{ nextcloud_version }}"
    restart_policy: unless-stopped
    networks:
      - name: "{{ docker_network }}"
    volumes:
      - "{{ data_root }}/nextcloud/html:/var/www/html"
      - "{{ data_root }}/nextcloud/data:/var/www/html/data"
    env:
      POSTGRES_HOST: "postgres"
      POSTGRES_DB: "nextcloud"
      POSTGRES_USER: "{{ postgres_user }}"
      POSTGRES_PASSWORD: "{{ postgres_password }}"
      NEXTCLOUD_ADMIN_USER: "{{ nextcloud_admin_user }}"
      NEXTCLOUD_ADMIN_PASSWORD: "{{ nextcloud_admin_password }}"
      NEXTCLOUD_TRUSTED_DOMAINS: "cloud.{{ domain }} {{ server_ip }}"
      REDIS_HOST: "redis"
      OVERWRITEPROTOCOL: "https"
      OVERWRITECLIURL: "https://cloud.{{ domain }}"
      TRUSTED_PROXIES: "caddy"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/status.php"]
      interval: 30s
      timeout: 10s
      retries: 5

- name: Wait for Nextcloud to be ready
  pause:
    seconds: 10